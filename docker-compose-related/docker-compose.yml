services:
  nemo-training:
    build:
      context: ..
      dockerfile: ../Dockerfile
    image: nemo-25.11-custom:latest
    runtime: nvidia
    ipc: host
    stdin_open: true
    tty: true
    volumes:
      # 数据目录
      - /data1:/data1
      - /data2:/data2
      - /data3:/data3
      - /mnt/asr-audio-data:/mnt/asr-audio-data
      - ../logs:/workspace/logs

      # RamosNeMo 源码目录 - 使用本地 entrance 脚本
      - ..:/opt/ramosnemo_source

    environment:
      - CUDA_VISIBLE_DEVICES=0,1,2,3,4,5,6,7
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    command: >
      /bin/bash -c "
        echo 'Container started. Available GPUs:' &&
        nvidia-smi &&
        echo '' &&
        pip show polars >/dev/null 2>&1 || pip install --no-cache-dir 'polars>=1.6.0' &&
        echo '' &&
        /opt/setup_ramosnemo.sh &&
        echo '' &&
        /bin/bash
      "
